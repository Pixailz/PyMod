#!/usr/bin/env python3

##
# HEADER

import os
import socket
import nmap3
import subprocess
import threading
import time

from utils import *

#
##

class ScanMachine():

    def __init__(self, target, o=True):

        self.target = target
        self.host = ""
        self.hostname = ""
        self.ports = []

        self.t1 = ""
        self.t2 = ""

        checkRoot(exitOnFail=False)
        
        if isup(self.target):

            print(f"{self.target} is up")

        else:

            print(f"{self.target} is down, exiting ..")
            exit()

        self.validTarget()

        self.t1 = time.time()

        self.scanPort()
        
        self.t2 = truncate(time.time() - self.t1)

        if o:
            self.output()
    
    def output(self):

        print("PORT\t\tSTATE\t\tSERVICE\t\tVERSION\n")

        for x in range(len(self.ports)):
            if len(self.ports[x]) == 5:
                print(f'{self.ports[x]["portid"]}/{self.ports[x]["protocol"]}  \t{self.ports[x]["state"]}    \t{self.ports[x]["service"]}     \t{self.ports[x]["version"]}')
            
            else:
                print(f'{self.ports[x]["portid"]}/{self.ports[x]["protocol"]}  \t{self.ports[x]["state"]}    \t{self.ports[x]["service"]}')
        
        print(f'\nHost ({self.target}) scanned in {self.t2} sec')

    def validTarget(self):

        try:

            socket.inet_aton(self.target)
            self.host = self.target
            hostname = socket.gethostbyaddr(self.target)
            self.hostname = hostname[0]

        except socket.error:

            self.hostname = self.target
            try:

                self.host = socket.gethostbyname(self.target)

            except socket.gaierror:

                print(f"Cannot get ip from {self.target}, exiting.")
                exit()

    def scanPort(self):

        port_s = nmap3.Nmap()
        port_o = port_s.nmap_version_detection(self.host)

        for x in range(len(port_o[self.host]["ports"])):
            OPEN_PORT = {
                "protocol" : "",
                "portid" : "",
                "state" : "",
                "service" : ""
            }

            OPEN_PORT["protocol"] = port_o[self.host]["ports"][x]["protocol"]
            OPEN_PORT["portid"] = port_o[self.host]["ports"][x]["portid"]
            OPEN_PORT["state"] = port_o[self.host]["ports"][x]["state"]
            OPEN_PORT["service"] = port_o[self.host]["ports"][x]["service"]["name"]

            if "product" in port_o[self.host]["ports"][x]["service"]:
                
                OPEN_PORT["version"] = port_o[self.host]["ports"][x]["service"]["product"]

                if "version" in port_o[self.host]["ports"][x]["service"]:

                    OPEN_PORT["version"] = OPEN_PORT["version"] + port_o[self.host]["ports"][x]["service"]["version"]

            self.ports.append(OPEN_PORT)

    def afficher(self):

        print(f"target :\t{self.target}")
        print(f"host :\t\t{self.host}")
        print(f"hostname :\t{self.hostname}")
        print(f"ports :\t\t{self.ports}")
        print(f"T1 :\t\t{self.t1}")
        print(f"T2 :\t\t{self.t2}")

class SubnetScan():
    
    def __init__(self, target, timeout=2.5, o=True):
    
        self.target = target
        self.ipup = []
        self.timeout = timeout
        self.threads = []

        self.t1 = ""
        self.t2 = ""

        checkRoot(exitOnFail=False)

        self.t1 = time.time()
        self.threading()
        self.t2 = truncate(time.time() - self.t1)

        if o:
            self.output()

    def isup(self, target, x):
        
        if os.name == "posix":

            ping = subprocess.run(["ping", "-c", "1", "-s", "0", target], stdout=subprocess.PIPE)

        elif os.name == "nt":

            ping = subprocess.run(["ping", "-n", "1", "-l", "0", target], stdout=subprocess.PIPE)

        if "ttl=" in str(ping.stdout).lower():

            self.ipup.append(x)
    
    def threading(self):
        
        count = 0

        for x in range(0,255+1):

            ip = f"{self.target}.{x}"
            count += 1
            t = threading.Thread(target=self.isup, args=(ip,x))
            t.start()
            self.threads.append(t)

        for process in self.threads:

            process.join()

    def output(self):

        print("{} hosts scanned in {} sec\n".format(len(self.ipup), self.t2))

        self.ipup.sort(reverse=True)
        for x in range(len(self.ipup)):
        
            print("{}.{} is up".format(self.target, self.ipup[x]))

if __name__ == "__main__":

    answer = menu(content=["Scan Port", "Scan Subnet"], title="Pentest")

    if answer == "1":
        ScanMachine(input("Enter a target : "))

    elif answer == "2":
        SubnetScan(input("Enter a target : "))
